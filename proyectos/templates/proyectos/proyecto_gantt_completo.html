{% extends "base.html" %}

{% block title %}Diagrama de Gantt - {{ proyecto.codigo_proyecto }}{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <link rel="stylesheet" href="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css">
    
    <style>
        .gantt_grid_head_cell {
            padding: 8px 5px;
            font-weight: 600;
            font-size: 13px;
        }
        
        .gantt_cell {
            padding: 6px 8px;
            font-size: 13px;
        }
        
        .gantt_row, .gantt_task_row {
            height: 35px !important;
        }
        
        .gantt_task_line {
            margin-top: 8px;
            border-radius: 4px;
        }
        
        /* D√≠as no laborales */
        .gantt_task_cell.weekend {
            background-color: #fff4f4 !important;
        }
        
        .gantt_scale_cell.weekend {
            background-color: #ffe6e6 !important;
            color: #d32f2f !important;
            font-weight: 600;
        }
        
        .gantt_scale_cell {
            border-right: 1px solid #ddd;
        }
        
        /* Nivel 1: Mes */
        .gantt_scale_line:first-child .gantt_scale_cell {
            background-color: #1565c0 !important;
            color: white !important;
            font-weight: bold;
            font-size: 13px;
            text-align: center;
            border-right: 1px solid #0d47a1;
        }
        
        /* Nivel 2: D√≠a de la semana */
        .gantt_scale_line:nth-child(2) .gantt_scale_cell {
            background-color: #42a5f5 !important;
            color: white !important;
            font-weight: 600;
            font-size: 12px;
            text-align: center;
        }
        
        .gantt_scale_line:nth-child(2) .gantt_scale_cell.weekend {
            background-color: #ef5350 !important;
        }
        
        /* Nivel 3: N√∫mero del d√≠a */
        .gantt_scale_line:nth-child(3) .gantt_scale_cell {
            background-color: #e3f2fd !important;
            color: #1565c0 !important;
            font-weight: 500;
            font-size: 11px;
        }
        
        .gantt_scale_line:nth-child(3) .gantt_scale_cell.weekend {
            background-color: #ffcdd2 !important;
            color: #c62828 !important;
        }
        
        /* Colores por estado */
        .gantt_task_line.estado-planificado {
            background-color: #2196F3;
            border: 1px solid #1976D2;
        }
        
        .gantt_task_line.estado-en-curso {
            background-color: #FF9800;
            border: 1px solid #F57C00;
        }
        
        .gantt_task_line.estado-completado {
            background-color: #4CAF50;
            border: 1px solid #388E3C;
        }
        
        .gantt_task_line.estado-retrasado {
            background-color: #F44336;
            border: 1px solid #D32F2F;
        }
        
        .gantt_task_line.estado-pausado {
            background-color: #9E9E9E;
            border: 1px solid #757575;
        }
        
        .gantt_task_line.gantt_critical_task {
            background-color: #E91E63 !important;
            border: 2px solid #C2185B !important;
        }
        
        /* Estilos para tipos de enlaces/dependencias */
        /* FC - Fin-Comienzo (tipo 0) - Azul - M√ÅS COM√öN */
        .gantt_link_line.gantt_link_0,
        .gantt_line_wrapper.gantt_link_0 .gantt_link_line,
        .gantt_line_wrapper[link_id] .gantt_link_line {
            stroke: #2196F3 !important;
            stroke-width: 2px !important;
        }
        
        .gantt_link_arrow.gantt_link_0,
        .gantt_line_wrapper.gantt_link_0 .gantt_link_arrow {
            fill: #2196F3 !important;
            stroke: #2196F3 !important;
        }
        
        /* CC - Comienzo-Comienzo (tipo 1) - Verde */
        .gantt_link_line.gantt_link_1,
        .gantt_line_wrapper.gantt_link_1 .gantt_link_line {
            stroke: #4CAF50 !important;
            stroke-width: 2px !important;
        }
        
        .gantt_link_arrow.gantt_link_1,
        .gantt_line_wrapper.gantt_link_1 .gantt_link_arrow {
            fill: #4CAF50 !important;
            stroke: #4CAF50 !important;
        }
        
        /* FF - Fin-Fin (tipo 2) - Naranja */
        .gantt_link_line.gantt_link_2,
        .gantt_line_wrapper.gantt_link_2 .gantt_link_line {
            stroke: #FF9800 !important;
            stroke-width: 2px !important;
        }
        
        .gantt_link_arrow.gantt_link_2,
        .gantt_line_wrapper.gantt_link_2 .gantt_link_arrow {
            fill: #FF9800 !important;
            stroke: #FF9800 !important;
        }
        
        /* CF - Comienzo-Fin (tipo 3) - Rojo */
        .gantt_link_line.gantt_link_3,
        .gantt_line_wrapper.gantt_link_3 .gantt_link_line {
            stroke: #F44336 !important;
            stroke-width: 2px !important;
        }
        
        .gantt_link_arrow.gantt_link_3,
        .gantt_line_wrapper.gantt_link_3 .gantt_link_arrow {
            fill: #F44336 !important;
            stroke: #F44336 !important;
        }
        
        /* Forzar estilos generales para todos los enlaces */
        .gantt_task_link .gantt_link_line {
            stroke-width: 2px !important;
        }
        
        .gantt_task_link .gantt_link_arrow {
            stroke-width: 1px !important;
        }
        
        /* Sobrescribir color por defecto */
        .gantt_task_link path {
            stroke: inherit !important;
        }
        
        .gantt_task_link polygon {
            fill: inherit !important;
            stroke: inherit !important;
        }
        
        /* Ruta cr√≠tica para enlaces */
        .gantt_link_line.gantt_critical_link {
            stroke: #E91E63 !important;
            stroke-width: 3px !important;
        }
        
        .gantt_link_arrow.gantt_critical_link {
            fill: #E91E63 !important;
        }
        
        .gantt-toolbar {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .gantt-toolbar .btn-group {
            display: flex;
            gap: 5px;
        }
        
        .gantt-toolbar .btn {
            font-size: 12px;
            padding: 5px 12px;
        }
        
        .gantt-toolbar .separator {
            width: 1px;
            height: 30px;
            background-color: #dee2e6;
            margin: 0 5px;
        }
        
        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: 600;
            z-index: 10000;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .save-indicator.saving {
            background-color: #FFF3CD;
            color: #856404;
            display: block;
        }
        
        .save-indicator.saved {
            background-color: #D4EDDA;
            color: #155724;
            display: block;
        }
        
        .save-indicator.error {
            background-color: #F8D7DA;
            color: #721C24;
            display: block;
        }
        
        .gantt-legend {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-top: 1px solid #dee2e6;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            font-size: 12px;
        }
        
        .gantt-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .gantt-legend-color {
            width: 30px;
            height: 15px;
            border-radius: 3px;
            border: 1px solid #999;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div id="saveIndicator" class="save-indicator">
        <span id="saveMessage"></span>
    </div>
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Diagrama de Gantt</h2>
        <a href="{% url 'proyectos:proyecto_detail' proyecto.id_proyecto %}" class="btn btn-secondary btn-sm">
            <i class="bi bi-arrow-left"></i> Volver al proyecto
        </a>
    </div>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <strong>{{ proyecto.codigo_proyecto }} - {{ proyecto.nombre_proyecto }}</strong>
            <span class="badge bg-info">Modo Edici√≥n</span>
        </div>
        
        <div class="gantt-toolbar">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="setZoom('day')">
                    <i class="bi bi-calendar-day"></i> D√≠a
                </button>
                <button type="button" class="btn btn-sm btn-primary" onclick="setZoom('week')">
                    <i class="bi bi-calendar-week"></i> Semana
                </button>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="setZoom('month')">
                    <i class="bi bi-calendar-month"></i> Mes
                </button>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="setZoom('year')">
                    <i class="bi bi-calendar"></i> A√±o
                </button>
            </div>
            
            <div class="separator"></div>
            
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-sm btn-outline-danger" id="btnCriticalPath" onclick="toggleCriticalPath()">
                    <i class="bi bi-lightning"></i> Ruta Cr√≠tica
                </button>
            </div>
            
            <div class="separator"></div>
            
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-sm btn-outline-success" onclick="exportToExcel()">
                    <i class="bi bi-file-excel"></i> Exportar Excel
                </button>
            </div>
        </div>
        
        <div class="card-body p-0">
            <div id="gantt_here" style="width: 100%; height: 700px;"></div>
        </div>
        
        <div class="gantt-legend">
            <strong>Estados:</strong>
            <div class="gantt-legend-item">
                <div class="gantt-legend-color" style="background-color: #2196F3;"></div>
                <span>Planificado</span>
            </div>
            <div class="gantt-legend-item">
                <div class="gantt-legend-color" style="background-color: #FF9800;"></div>
                <span>En Curso</span>
            </div>
            <div class="gantt-legend-item">
                <div class="gantt-legend-color" style="background-color: #4CAF50;"></div>
                <span>Completado</span>
            </div>
            <div class="gantt-legend-item">
                <div class="gantt-legend-color" style="background-color: #F44336;"></div>
                <span>Retrasado</span>
            </div>
            
            <div class="separator" style="width: 2px; height: 20px; background-color: #dee2e6; margin: 0 10px;"></div>

            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    {{ block.super }}
    <script src="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js"></script>

    <script>
        (function() {
            const PROYECTO_ID = {{ proyecto.id_proyecto }};
            const URL_SAVE = "{% url 'proyectos:proyecto_gantt_save' proyecto.id_proyecto %}";
            const URL_DATA = "{% url 'proyectos:proyecto_gantt_data' proyecto.id_proyecto %}";
            const URL_LINK_SAVE = "{% url 'proyectos:proyecto_gantt_link_save' proyecto.id_proyecto %}";
            const URL_LINK_DELETE = "{% url 'proyectos:proyecto_gantt_link_delete' proyecto.id_proyecto %}";
            
            let autoSaveTimer = null;
            let criticalPathEnabled = false;
            
            const festivosColombia2025 = [
                "2025-01-01", "2025-01-06", "2025-03-24", "2025-04-17", 
                "2025-04-18", "2025-04-21", "2025-05-01", "2025-06-16",
                "2025-06-23", "2025-06-30", "2025-07-20", "2025-08-07",
                "2025-08-18", "2025-10-13", "2025-11-03", "2025-11-17",
                "2025-12-08", "2025-12-25"
            ];
            
            function esDiaNoLaboral(fecha) {
                const date = typeof fecha === 'string' ? new Date(fecha + 'T12:00:00') : fecha;
                if (date.getDay() === 0) return true;
                const fechaStr = gantt.date.date_to_str("%Y-%m-%d")(date);
                return festivosColombia2025.includes(fechaStr);
            }
            
            gantt.config.xml_date = "%Y-%m-%d";
            gantt.config.date_format = "%Y-%m-%d";
            gantt.config.grid_resize = true;
            gantt.config.row_height = 35;
            gantt.config.scale_height = 90;
            gantt.config.duration_unit = "day";
            gantt.config.work_time = true;
            gantt.config.show_links = true;
            gantt.config.scroll_size = 20;
            gantt.config.fit_tasks = true;
            gantt.config.show_grid = true;
            gantt.config.min_column_width = 70;
            gantt.config.today_marker = true;
            
            // Configuraci√≥n de dependencias
            gantt.config.drag_links = true;
            gantt.config.auto_scheduling = false; // Usaremos manual
            
            // ========================================================
            // CONFIGURAR COLORES DE ENLACES POR TIPO
            // ========================================================
            gantt.config.link_line_width = 2;
            gantt.config.link_arrow_size = 8;
            
            // Forzar colores usando eventos de renderizado
            gantt.attachEvent("onLinkDblClick", function(id, e){
                return true; // Permitir doble click
            });
            
            // Aplicar estilo directo al SVG cuando se dibuja
            gantt.attachEvent("onBeforeLinkDisplay", function(id, link){
                return true;
            });
            
            gantt.config.columns = [
                {
                    name: "text", 
                    label: "Actividad", 
                    width: 300, 
                    tree: true,
                    resize: true
                },
                {
                    name: "start_date", 
                    label: "Inicio", 
                    align: "center", 
                    width: 95,
                    resize: true,
                    template: function(obj) {
                        if (!obj.start_date) return "";
                        const day = String(obj.start_date.getDate()).padStart(2, '0');
                        const month = String(obj.start_date.getMonth() + 1).padStart(2, '0');
                        const year = obj.start_date.getFullYear();
                        return day + "/" + month + "/" + year;
                    }
                },
                {
                    name: "end_date", 
                    label: "Fin", 
                    align: "center", 
                    width: 95,
                    resize: true,
                    template: function(obj) {
                        const endDate = gantt.calculateEndDate({
                            start_date: obj.start_date,
                            duration: obj.duration
                        });
                        if (!endDate) return "";
                        const day = String(endDate.getDate()).padStart(2, '0');
                        const month = String(endDate.getMonth() + 1).padStart(2, '0');
                        const year = endDate.getFullYear();
                        return day + "/" + month + "/" + year;
                    }
                },
                {
                    name: "duration", 
                    label: "D√≠as", 
                    align: "center", 
                    width: 60,
                    resize: true
                }
            ];
            
            function setScaleConfig(level) {
                if (level === "day") {
                    gantt.config.scales = [
                        {unit: "month", step: 1, format: function(date) {
                            const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                                         "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                            return meses[date.getMonth()] + " " + date.getFullYear();
                        }},
                        {unit: "day", step: 1, format: function(date) {
                            const dias = ["D", "L", "M", "M", "J", "V", "S"];
                            return dias[date.getDay()];
                        }},
                        {unit: "day", step: 1, format: "%d"}
                    ];
                    gantt.config.scale_height = 90;
                    gantt.config.min_column_width = 40;
                } else if (level === "week") {
                    gantt.config.scales = [
                        {unit: "month", step: 1, format: "%F %Y"},
                        {unit: "week", step: 1, format: "Semana #%W"}
                    ];
                    gantt.config.scale_height = 60;
                    gantt.config.min_column_width = 70;
                } else if (level === "month") {
                    gantt.config.scales = [
                        {unit: "year", step: 1, format: "%Y"},
                        {unit: "month", step: 1, format: "%M"}
                    ];
                    gantt.config.scale_height = 60;
                    gantt.config.min_column_width = 60;
                } else if (level === "year") {
                    gantt.config.scales = [
                        {unit: "year", step: 1, format: "%Y"},
                        {unit: "quarter", step: 1, format: function(date) {
                            const month = date.getMonth();
                            const quarter = Math.floor(month / 3) + 1;
                            return "Q" + quarter;
                        }}
                    ];
                    gantt.config.scale_height = 60;
                    gantt.config.min_column_width = 100;
                }
            }
            
            setScaleConfig("day");
            
            gantt.templates.scale_cell_class = function(date) {
                return esDiaNoLaboral(date) ? "weekend" : "";
            };
            
            gantt.templates.timeline_cell_class = function(task, date) {
                return esDiaNoLaboral(date) ? "weekend" : "";
            };
            
            gantt.templates.task_class = function(start, end, task) {
                let classes = [];
                if (task.estado) {
                    classes.push('estado-' + task.estado.toLowerCase().replace(/\s+/g, '-'));
                }
                if (criticalPathEnabled && task.critical) {
                    classes.push('gantt_critical_task');
                }
                return classes.join(' ');
            };
            
            gantt.templates.tooltip_text = function(start, end, task) {
                const formatFecha = function(date) {
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return day + "/" + month + "/" + year;
                };
                return "<b>Actividad:</b> " + task.text + "<br/>" +
                       "<b>Inicio:</b> " + formatFecha(start) + "<br/>" +
                       "<b>Fin:</b> " + formatFecha(end) + "<br/>" +
                       "<b>Duraci√≥n:</b> " + task.duration + " d√≠as<br/>" +
                       "<b>Progreso:</b> " + Math.round(task.progress * 100) + "%";
            };
            
            // Template para tooltip de enlaces
            gantt.templates.link_description = function(link) {
                const tipos = {
                    "0": "FC (Fin-Comienzo)",
                    "1": "CC (Comienzo-Comienzo)",
                    "2": "FF (Fin-Fin)",
                    "3": "CF (Comienzo-Fin)"
                };
                
                const origen = gantt.getTask(link.source);
                const destino = gantt.getTask(link.target);
                const tipoTexto = tipos[link.type] || "FC (Fin-Comienzo)";
                const lagTexto = link.lag ? (link.lag > 0 ? " +" + link.lag + " d√≠as" : " " + link.lag + " d√≠as") : "";
                
                return "<b>Dependencia:</b> " + tipoTexto + lagTexto + "<br/>" +
                       "<b>Predecesora:</b> " + origen.text + "<br/>" +
                       "<b>Sucesora:</b> " + destino.text;
            };
            
            // Template para clase CSS de enlaces seg√∫n tipo
            gantt.templates.link_class = function(link) {
                return "gantt_link_" + link.type;
            };
            
            // ========================================================
            // COLOREAR ENLACES SEG√öN TIPO (JAVASCRIPT)
            // ========================================================
            
            // Funci√≥n para aplicar colores a los enlaces
            function aplicarColoresEnlaces() {
                const colores = {
                    "0": "#2196F3", // FC - Azul
                    "1": "#4CAF50", // CC - Verde
                    "2": "#FF9800", // FF - Naranja
                    "3": "#F44336"  // CF - Rojo
                };
                
                try {
                    console.log('üé® Iniciando aplicaci√≥n de colores...');
                    
                    // M√âTODO PRINCIPAL: Colorear TODOS los SVG de enlaces directamente
                    colorearTodosLosSVG();
                    
                } catch (error) {
                    console.error('Error al colorear enlaces:', error);
                }
            }
            
            // M√©todo directo: buscar todos los SVG y colorearlos
            function colorearTodosLosSVG() {
                const colores = {
                    "0": "#2196F3",
                    "1": "#4CAF50",
                    "2": "#FF9800",
                    "3": "#F44336"
                };
                
                // Obtener enlaces del API de Gantt
                const linksObj = gantt.getLinks();
                console.log('üìä Enlaces del API:', linksObj);
                
                // Convertir a array si es necesario
                let linksArray = [];
                if (Array.isArray(linksObj)) {
                    linksArray = linksObj;
                } else if (typeof linksObj === 'object') {
                    // Es un objeto, convertir a array
                    linksArray = Object.values(linksObj);
                }
                
                console.log(`üìä Total enlaces en API: ${linksArray.length}`);
                
                // Buscar todos los contenedores de enlaces en el DOM
                const linkWrappers = document.querySelectorAll('.gantt_line_wrapper');
                console.log(`üîç Total wrappers en DOM: ${linkWrappers.length}`);
                
                let contadorColoreados = 0;
                
                // M√âTODO 1: Iterar por los enlaces del API y buscar sus SVG
                linksArray.forEach(link => {
                    if (!link || typeof link.id === 'undefined') {
                        return;
                    }
                    
                    const linkId = link.id;
                    const tipo = link.type || "0";
                    const color = colores[String(tipo)] || "#2196F3";
                    
                    console.log(`\nüîó Procesando enlace ID ${linkId}, tipo ${tipo}, color ${color}`);
                    
                    // Buscar wrapper por posici√≥n relativa o aplicar a todos
                    // Como no tienen link_id, aplicaremos color a TODOS los paths/polygons
                    // de cada wrapper en orden
                });
                
                // M√âTODO 2: Aplicar colores por √≠ndice
                linkWrappers.forEach((wrapper, index) => {
                    if (index < linksArray.length) {
                        const link = linksArray[index];
                        if (link && typeof link.type !== 'undefined') {
                            const color = colores[String(link.type)] || "#2196F3";
                            
                            console.log(`\nüìç Wrapper ${index}: Enlace ID ${link.id}, tipo ${link.type}, color ${color}`);
                            
                            // Colorear todos los paths
                            const paths = wrapper.querySelectorAll('path');
                            paths.forEach(path => {
                                path.style.stroke = color;
                                path.setAttribute('stroke', color);
                                path.setAttribute('stroke-width', '2');
                            });
                            
                            // Colorear todos los polygons (flechas)
                            const polygons = wrapper.querySelectorAll('polygon');
                            polygons.forEach(polygon => {
                                polygon.style.fill = color;
                                polygon.style.stroke = color;
                                polygon.setAttribute('fill', color);
                                polygon.setAttribute('stroke', color);
                            });
                            
                            contadorColoreados++;
                            console.log(`   ‚úì Coloreado: ${paths.length} paths, ${polygons.length} polygons`);
                        }
                    }
                });
                
                console.log(`\n‚úÖ Total enlaces coloreados: ${contadorColoreados}`);
            }
            
            // Aplicar colores despu√©s de renderizar el Gantt
            gantt.attachEvent("onGanttRender", function() {
                setTimeout(aplicarColoresEnlaces, 300);
            });
            
            // Aplicar colores despu√©s de crear enlace
            gantt.attachEvent("onAfterLinkAdd", function(id, link){
                setTimeout(aplicarColoresEnlaces, 300);
                saveLinkChanges(id, link);
                setTimeout(() => recalcularFechasPorDependencias(link.target), 200);
                return true;
            });
            
            // Aplicar colores despu√©s de actualizar enlace
            gantt.attachEvent("onAfterLinkUpdate", function(id, link){
                setTimeout(aplicarColoresEnlaces, 300);
                saveLinkChanges(id, link);
                setTimeout(() => recalcularFechasPorDependencias(link.target), 200);
                return true;
            });
            
            gantt.plugins({
                tooltip: true
            });
            
            gantt.setWorkTime({hours: [8, 17]});
            gantt.setWorkTime({day: 0, hours: false});
            festivosColombia2025.forEach(function(festivo) {
                gantt.setWorkTime({
                    date: new Date(festivo + 'T12:00:00'),
                    hours: false
                });
            });
            
            function showSaveIndicator(status, message) {
                const indicator = document.getElementById('saveIndicator');
                const messageSpan = document.getElementById('saveMessage');
                indicator.className = 'save-indicator ' + status;
                messageSpan.textContent = message;
                if (status !== 'saving') {
                    setTimeout(function() {
                        indicator.style.display = 'none';
                    }, 3000);
                }
            }
            
            function saveChanges(taskId) {
                showSaveIndicator('saving', 'Guardando cambios...');
                const task = gantt.getTask(taskId);
                const data = {
                    id: task.id,
                    text: task.text,
                    start_date: gantt.date.date_to_str("%Y-%m-%d")(task.start_date),
                    duration: task.duration,
                    progress: task.progress,
                    parent: task.parent || null
                };
                
                fetch(URL_SAVE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showSaveIndicator('saved', '‚úì Cambios guardados');
                    } else {
                        showSaveIndicator('error', '‚úó Error: ' + result.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showSaveIndicator('error', '‚úó Error de conexi√≥n');
                });
            }
            
            gantt.attachEvent("onAfterTaskUpdate", function(id, task){
                // NO guardar autom√°ticamente durante auto-scheduling
                // Solo guardar cambios manuales del usuario
                if (!gantt._auto_scheduling_in_progress) {
                    clearTimeout(autoSaveTimer);
                    autoSaveTimer = setTimeout(function() {
                        saveChanges(id);
                    }, 2000);
                }
                return true;
            });
            
            gantt.attachEvent("onAfterTaskDrag", function(id, mode, e){
                // Guardar inmediatamente despu√©s de arrastrar
                saveChanges(id);
                return true;
            });
            
            // ========================================================
            // AUTO-SCHEDULING MANUAL (MEJORADO)
            // ========================================================
            
            function recalcularFechasPorDependencias(taskId) {
                // Marcar que estamos en auto-scheduling
                gantt._auto_scheduling_in_progress = true;
                
                const task = gantt.getTask(taskId);
                
                // CR√çTICO: Guardar duraci√≥n original ANTES de cualquier c√°lculo
                const duracionOriginal = task.duration;
                const fechaInicioOriginal = task.start_date;
                
                console.log('üîç Recalculando:', task.text);
                console.log('   Duraci√≥n original:', duracionOriginal, 'd√≠as');
                console.log('   Fecha inicio original:', gantt.date.date_to_str("%Y-%m-%d")(fechaInicioOriginal));
                
                const todosLosEnlaces = gantt.getLinks();
                
                // Buscar enlaces donde esta tarea es destino (sucesora)
                const enlacesPredecesores = todosLosEnlaces.filter(link => link.target == taskId);
                
                if (enlacesPredecesores.length === 0) {
                    console.log('   ‚úì Sin predecesores, no se modifica');
                    return;
                }
                
                let nuevaFechaInicio = null;
                
                enlacesPredecesores.forEach(link => {
                    const predecesora = gantt.getTask(link.source);
                    const lag = link.lag || 0;
                    const tipos = {0: 'FC', 1: 'CC', 2: 'FF', 3: 'CF'};
                    
                    console.log('   Dependencia:', tipos[link.type], 'de', predecesora.text);
                    
                    let fechaCalculada;
                    
                    switch(link.type) {
                        case "0": // FC - Fin-Comienzo
                            const finA_FC = gantt.calculateEndDate({
                                start_date: predecesora.start_date,
                                duration: predecesora.duration,
                                unit: 'day'
                            });
                            fechaCalculada = gantt.calculateEndDate({
                                start_date: finA_FC,
                                duration: lag,
                                unit: 'day'
                            });
                            break;
                            
                        case "1": // CC - Comienzo-Comienzo
                            fechaCalculada = gantt.calculateEndDate({
                                start_date: predecesora.start_date,
                                duration: lag,
                                unit: 'day'
                            });
                            break;
                            
                        case "2": // FF - Fin-Fin
                            const finA_FF = gantt.calculateEndDate({
                                start_date: predecesora.start_date,
                                duration: predecesora.duration,
                                unit: 'day'
                            });
                            const finB = gantt.calculateEndDate({
                                start_date: finA_FF,
                                duration: lag,
                                unit: 'day'
                            });
                            fechaCalculada = gantt.calculateEndDate({
                                start_date: finB,
                                duration: -duracionOriginal,
                                unit: 'day'
                            });
                            break;
                            
                        case "3": // CF - Comienzo-Fin
                            const finB_CF = gantt.calculateEndDate({
                                start_date: predecesora.start_date,
                                duration: lag,
                                unit: 'day'
                            });
                            fechaCalculada = gantt.calculateEndDate({
                                start_date: finB_CF,
                                duration: -duracionOriginal,
                                unit: 'day'
                            });
                            break;
                            
                        default:
                            fechaCalculada = predecesora.start_date;
                    }
                    
                    console.log('   Fecha calculada:', gantt.date.date_to_str("%Y-%m-%d")(fechaCalculada));
                    
                    if (!nuevaFechaInicio || fechaCalculada > nuevaFechaInicio) {
                        nuevaFechaInicio = fechaCalculada;
                    }
                });
                
                // Solo actualizar si cambi√≥ la fecha
                if (nuevaFechaInicio && nuevaFechaInicio.getTime() !== fechaInicioOriginal.getTime()) {
                    console.log('   üìÖ Nueva fecha inicio:', gantt.date.date_to_str("%Y-%m-%d")(nuevaFechaInicio));
                    console.log('   ‚è±Ô∏è  Duraci√≥n a mantener:', duracionOriginal, 'd√≠as');
                    
                    // M√âTODO 1: Actualizar directamente sin eventos
                    // Desactivar eventos temporalmente
                    gantt.config.auto_scheduling = false;
                    
                    // Actualizar propiedades directamente
                    task.start_date = nuevaFechaInicio;
                    task.duration = duracionOriginal;
                    task.end_date = gantt.calculateEndDate({
                        start_date: nuevaFechaInicio,
                        duration: duracionOriginal,
                        unit: 'day'
                    });
                    
                    // Forzar renderizado visual SIN disparar eventos
                    gantt.refreshTask(task.id);
                    
                    console.log('   ‚úì Actualizado en memoria');
                    console.log('   üìä Verificaci√≥n - Duraci√≥n despu√©s:', task.duration);
                    
                    // Preparar datos para guardar EXPL√çCITAMENTE
                    const datosAGuardar = {
                        id: task.id,
                        text: task.text,
                        start_date: gantt.date.date_to_str("%Y-%m-%d")(nuevaFechaInicio),
                        duration: duracionOriginal,  // ‚Üê FORZAR duraci√≥n original
                        progress: task.progress,
                        parent: task.parent || null
                    };
                    
                    console.log('   üíæ Guardando:', datosAGuardar);
                    
                    // Guardar con datos expl√≠citos
                    saveChangesExplicit(datosAGuardar);
                    
                    // Mostrar mensaje
                    gantt.message({
                        text: "üìÖ Inicio ajustado. Duraci√≥n: " + duracionOriginal + " d√≠as",
                        type: "info"
                    });
                    
                    // Reactivar auto-scheduling
                    setTimeout(() => {
                        gantt.config.auto_scheduling = false; // Mantener en false
                        
                        // Recalcular sucesores
                        const enlacesSuccesores = todosLosEnlaces.filter(link => link.source == taskId);
                        enlacesSuccesores.forEach(link => {
                            setTimeout(() => recalcularFechasPorDependencias(link.target), 150);
                        });
                    }, 100);
                } else {
                    console.log('   ‚úì Fecha no cambi√≥, no se actualiza');
                }
            }
            
            // Nueva funci√≥n para guardar con datos expl√≠citos
            function saveChangesExplicit(data) {
                showSaveIndicator('saving', 'Guardando cambios...');
                
                console.log('üì§ Enviando a servidor:', data);
                
                fetch(URL_SAVE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(result => {
                    console.log('üì• Respuesta servidor:', result);
                    if (result.success) {
                        showSaveIndicator('saved', '‚úì Guardado (duraci√≥n: ' + data.duration + 'd)');
                    } else {
                        showSaveIndicator('error', '‚úó Error: ' + result.error);
                    }
                })
                .catch(error => {
                    console.error('‚ùå Error:', error);
                    showSaveIndicator('error', '‚úó Error de conexi√≥n');
                });
            }
            
            // ========================================================
            // EVENTOS PARA ENLACES (DEPENDENCIAS)
            // ========================================================
            
            // Validar antes de crear enlace
            gantt.attachEvent("onBeforeLinkAdd", function(id, link){
                if (link.source == link.target) {
                    gantt.message({
                        text: "‚ùå Una actividad no puede enlazarse consigo misma",
                        type: "error"
                    });
                    return false;
                }
                return true;
            });
            
            // Los eventos onAfterLinkAdd y onAfterLinkUpdate ya est√°n definidos arriba
            // con la funci√≥n aplicarColoresEnlaces
            
            // Eliminar enlace
            gantt.attachEvent("onAfterLinkDelete", function(id, link){
                deleteLinkChanges(id);
                return true;
            });
            
            // Funci√≥n para guardar enlaces
            function saveLinkChanges(linkId, link) {
                showSaveIndicator('saving', 'Guardando dependencia...');
                
                const linkData = link || gantt.getLink(linkId);
                
                const data = {
                    id: linkData.id,
                    source: linkData.source,
                    target: linkData.target,
                    type: linkData.type,
                    lag: linkData.lag || 0
                };
                
                fetch(URL_LINK_SAVE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        // Actualizar ID temporal con ID real de la base de datos
                        if (String(linkData.id).startsWith('t')) {
                            linkData.id = result.id;
                        }
                        showSaveIndicator('saved', '‚úì Dependencia guardada');
                    } else {
                        showSaveIndicator('error', '‚úó Error: ' + result.error);
                        gantt.deleteLink(linkId);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showSaveIndicator('error', '‚úó Error al guardar dependencia');
                    gantt.deleteLink(linkId);
                });
            }
            
            // Funci√≥n para eliminar enlaces
            function deleteLinkChanges(linkId) {
                showSaveIndicator('saving', 'Eliminando dependencia...');
                
                const data = { id: linkId };
                
                fetch(URL_LINK_DELETE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showSaveIndicator('saved', '‚úì Dependencia eliminada');
                    } else {
                        showSaveIndicator('error', '‚úó Error: ' + result.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showSaveIndicator('error', '‚úó Error al eliminar dependencia');
                });
            }
            
            window.toggleCriticalPath = function() {
                criticalPathEnabled = !criticalPathEnabled;
                const btn = document.getElementById('btnCriticalPath');
                if (criticalPathEnabled) {
                    gantt.config.highlight_critical_path = true;
                    gantt.eachTask(function(task) {
                        task.critical = gantt.isCriticalTask(task);
                    });
                    btn.classList.remove('btn-outline-danger');
                    btn.classList.add('btn-danger');
                } else {
                    gantt.config.highlight_critical_path = false;
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-outline-danger');
                }
                gantt.render();
            };
            
            window.setZoom = function(level) {
                setScaleConfig(level);
                gantt.render();
                document.querySelectorAll('.gantt-toolbar .btn-group button').forEach(function(btn) {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline-primary');
                });
                event.target.classList.remove('btn-outline-primary');
                event.target.classList.add('btn-primary');
            };
            
            window.exportToExcel = function() {
                const data = [];
                gantt.eachTask(function(task) {
                    const endDate = gantt.calculateEndDate({
                        start_date: task.start_date,
                        duration: task.duration
                    });
                    const formatFecha = function(date) {
                        const day = String(date.getDate()).padStart(2, '0');
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const year = date.getFullYear();
                        return day + "/" + month + "/" + year;
                    };
                    
                    // Crear barra visual de progreso
                    const progreso = Math.round(task.progress * 100);
                    const barraLongitud = 20;
                    const caracteresLlenos = Math.round((progreso / 100) * barraLongitud);
                    const caracteresVacios = barraLongitud - caracteresLlenos;
                    const barraVisual = '‚ñà'.repeat(caracteresLlenos) + '‚ñë'.repeat(caracteresVacios);
                    
                    data.push({
                        'Actividad': task.text,
                        'Fecha Inicio': formatFecha(task.start_date),
                        'Fecha Fin': formatFecha(endDate),
                        'Duraci√≥n (d√≠as)': task.duration,
                        'Progreso (%)': progreso,
                        'Barra': barraVisual,
                        'Estado': task.estado || 'N/A'
                    });
                });
                
                let csv = '\uFEFF';
                csv += Object.keys(data[0]).join(',') + '\n';
                data.forEach(function(row) {
                    csv += Object.values(row).map(val => {
                        const strVal = String(val);
                        if (strVal.includes(',') || strVal.includes('"') || strVal.includes('\n')) {
                            return '"' + strVal.replace(/"/g, '""') + '"';
                        }
                        return strVal;
                    }).join(',') + '\n';
                });
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "gantt_proyecto_" + PROYECTO_ID + ".csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('‚úì Excel descargado\n\nIncluye:\n- Fechas y duraciones\n- Barra visual de progreso\n- Estados\n\nLos acentos se ven correctamente.');
            };
            
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            gantt.init("gantt_here");
            
            fetch(URL_DATA)
                .then(response => {
                    if (!response.ok) throw new Error('Error al cargar');
                    return response.json();
                })
                .then(json => {
                    gantt.parse(json);
                    gantt.showDate(new Date());
                    
                    // Aplicar colores a enlaces existentes despu√©s de cargar
                    console.log('üé® Aplicando colores a enlaces...');
                    setTimeout(aplicarColoresEnlaces, 800);
                })
                .catch(err => {
                    console.error("Error:", err);
                    alert("Error al cargar el Gantt");
                });

        })();
    </script>
{% endblock %}
