{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagrama de Gantt - {{ proyecto.codigo_proyecto }}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- dhtmlxGantt CSS -->
    <link rel="stylesheet" href="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css">
    <link rel="stylesheet" href="https://cdn.dhtmlx.com/gantt/edge/skins/dhtmlxgantt_material.css">
    
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        #gantt_here {
            width: 100%;
            height: calc(100vh - 60px);
        }
        
        .gantt_grid_scale .gantt_grid_head_cell,
        .gantt_task .gantt_task_scale .gantt_scale_cell {
            font-weight: bold;
            font-size: 12px;
        }
        
        /* MS Project-like styling */
        .gantt_task_line {
            border: 1px solid #3d85c6;
            background: linear-gradient(to bottom, #4a90e2 0%, #3d85c6 100%);
        }
        
        .gantt_task_line.gantt_project {
            background: linear-gradient(to bottom, #2c3e50 0%, #34495e 100%);
            border: 1px solid #2c3e50;
        }
        
        .gantt_task_line.gantt_milestone {
            background: #e74c3c;
            border: 2px solid #c0392b;
        }
        
        /* Task atrasada */
        .gantt_task_line.task-atrasada {
            background: linear-gradient(to bottom, #ff6b6b 0%, #e74c3c 100%) !important;
            border-color: #c0392b !important;
        }
        
        /* Task que necesita atención */
        .gantt_task_line.task-atencion {
            background: linear-gradient(to bottom, #feca57 0%, #f39c12 100%) !important;
            border-color: #e67e22 !important;
        }
        
        /* Task completada */
        .gantt_task_line.task-completada {
            background: linear-gradient(to bottom, #48dbfb 0%, #0abde3 100%) !important;
            border-color: #0984e3 !important;
        }
        
        /* Progress bar styling */
        .gantt_task_progress {
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }
        
        /* Grid header styling */
        .gantt_grid_head_cell {
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            padding: 8px 10px;
        }
        
        /* Today marker */
        .gantt_marker {
            background-color: #dc3545;
            opacity: 0.4;
        }
        
        /* Link styling */
        .gantt_link_arrow_right {
            border-left-color: #3d85c6;
        }
        
        .gantt_link_arrow_left {
            border-right-color: #3d85c6;
        }
        
        .gantt_line_wrapper div {
            background-color: #3d85c6;
        }
        
        /* Toolbar styling */
        .gantt-toolbar {
            background: #ffffff;
            border-bottom: 2px solid #dee2e6;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .gantt-toolbar h5 {
            margin: 0;
            color: #2c3e50;
        }
        
        .gantt-toolbar .btn-group {
            gap: 5px;
        }
        
        /* Tooltip custom styling */
        .gantt_tooltip {
            padding: 10px;
            background: #fff;
            border: 1px solid #ccc;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 4px;
            font-size: 12px;
            max-width: 300px;
        }
        
        .gantt_tooltip strong {
            color: #2c3e50;
        }
        
        .gantt_tooltip .tooltip-row {
            margin: 4px 0;
        }
        
        /* Legend */
        .gantt-legend {
            position: absolute;
            top: 70px;
            right: 20px;
            background: white;
            padding: 10px 15px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 11px;
        }
        
        .gantt-legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        
        .gantt-legend-color {
            width: 20px;
            height: 12px;
            margin-right: 8px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <!-- Toolbar -->
    <div class="gantt-toolbar">
        <div>
            <h5>
                <i class="bi bi-calendar-gantt"></i>
                Diagrama de Gantt - {{ proyecto.codigo_proyecto }}: {{ proyecto.nombre_proyecto }}
            </h5>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="gantt.ext.zoom.zoomIn()">
                <i class="bi bi-zoom-in"></i> Acercar
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="gantt.ext.zoom.zoomOut()">
                <i class="bi bi-zoom-out"></i> Alejar
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="gantt.ext.zoom.setLevel('day')">
                Día
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="gantt.ext.zoom.setLevel('week')">
                Semana
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="gantt.ext.zoom.setLevel('month')">
                Mes
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="gantt.exportToPDF()">
                <i class="bi bi-file-pdf"></i> Exportar PDF
            </button>
            <a href="{% url 'proyectos:proyecto_detail' proyecto.id_proyecto %}" class="btn btn-sm btn-outline-dark">
                <i class="bi bi-arrow-left"></i> Volver al Proyecto
            </a>
        </div>
    </div>
    
    <!-- Legend -->
    <div class="gantt-legend">
        <strong>Leyenda:</strong>
        <div class="gantt-legend-item">
            <div class="gantt-legend-color" style="background: linear-gradient(to bottom, #ff6b6b 0%, #e74c3c 100%);"></div>
            <span>Atrasada</span>
        </div>
        <div class="gantt-legend-item">
            <div class="gantt-legend-color" style="background: linear-gradient(to bottom, #feca57 0%, #f39c12 100%);"></div>
            <span>Necesita atención</span>
        </div>
        <div class="gantt-legend-item">
            <div class="gantt-legend-color" style="background: linear-gradient(to bottom, #48dbfb 0%, #0abde3 100%);"></div>
            <span>Completada</span>
        </div>
        <div class="gantt-legend-item">
            <div class="gantt-legend-color" style="background: linear-gradient(to bottom, #4a90e2 0%, #3d85c6 100%);"></div>
            <span>En progreso</span>
        </div>
        <div class="gantt-legend-item">
            <div class="gantt-legend-color" style="background: linear-gradient(to bottom, #2c3e50 0%, #34495e 100%);"></div>
            <span>Tarea padre</span>
        </div>
    </div>
    
    <!-- Gantt Container -->
    <div id="gantt_here"></div>
    
    <!-- dhtmlxGantt JS -->
    <script src="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js"></script>
    <script src="https://cdn.dhtmlx.com/gantt/edge/ext/dhtmlxgantt_marker.js"></script>
    <script src="https://cdn.dhtmlx.com/gantt/edge/ext/dhtmlxgantt_tooltip.js"></script>
    <script src="https://cdn.dhtmlx.com/gantt/edge/locale/locale_es.js"></script>
    
    <script>
        // Configuración de gantt
        gantt.config.xml_date = "%Y-%m-%d";
        gantt.config.date_format = "%Y-%m-%d";
        gantt.config.scale_unit = "day";
        gantt.config.date_scale = "%d %M";
        gantt.config.subscales = [
            {unit: "month", step: 1, date: "%F %Y"}
        ];
        
        // Habilitar características
        gantt.config.drag_links = true;  // Arrastrar para crear dependencias
        gantt.config.drag_progress = true;  // Arrastrar el progreso
        gantt.config.drag_resize = true;  // Redimensionar tareas
        gantt.config.drag_move = true;  // Mover tareas
        gantt.config.details_on_dblclick = false;  // Desactivar modal por defecto
        gantt.config.show_links = true;  // Mostrar dependencias
        gantt.config.order_branch = true;  // Permitir reordenar
        
        // Configurar grid (lado izquierdo)
        gantt.config.columns = [
            {name: "text", label: "Actividad", tree: true, width: 250, resize: true},
            {name: "duration", label: "Duración", align: "center", width: 70, resize: true},
            {name: "start_date", label: "Inicio", align: "center", width: 90, resize: true},
            {name: "end_date", label: "Fin", align: "center", width: 90, resize: true},
            {name: "responsable", label: "Responsable", align: "left", width: 120, resize: true},
            {name: "add", label: "", width: 44}
        ];
        
        // Configurar tooltips
        gantt.templates.tooltip_text = function(start, end, task) {
            var html = "<div class='gantt_tooltip'>";
            html += "<strong>" + task.text + "</strong><br/>";
            html += "<div class='tooltip-row'><strong>Inicio:</strong> " + gantt.templates.tooltip_date_format(start) + "</div>";
            html += "<div class='tooltip-row'><strong>Fin:</strong> " + gantt.templates.tooltip_date_format(end) + "</div>";
            html += "<div class='tooltip-row'><strong>Duración:</strong> " + task.duration + " días</div>";
            html += "<div class='tooltip-row'><strong>Progreso:</strong> " + Math.round(task.progress * 100) + "%</div>";
            
            if (task.responsable) {
                html += "<div class='tooltip-row'><strong>Responsable:</strong> " + task.responsable + "</div>";
            }
            
            if (task.cantidad_programada > 0) {
                html += "<div class='tooltip-row'><strong>Cantidad:</strong> " + task.cantidad_ejecutada.toFixed(2) + " / " + task.cantidad_programada.toFixed(2) + " " + task.unidad_medida + "</div>";
            }
            
            html += "</div>";
            return html;
        };
        
        // Aplicar estilos según estado
        gantt.templates.task_class = function(start, end, task) {
            var classes = [];
            
            // Determinar estado
            var progress = task.porcentaje_avance || 0;
            var today = new Date();
            var endDate = gantt.date.parseDate(task.end_date, "xml_date");
            
            if (progress >= 100) {
                classes.push("task-completada");
            } else if (endDate && endDate < today) {
                classes.push("task-atrasada");
            } else if (endDate) {
                var daysLeft = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                if (daysLeft <= 3 && progress < 100) {
                    classes.push("task-atencion");
                }
            }
            
            return classes.join(" ");
        };
        
        // Marcador para "hoy"
        var dateToStr = gantt.date.date_to_str(gantt.config.task_date);
        var today = new Date();
        gantt.addMarker({
            start_date: today,
            css: "gantt_marker",
            text: "Hoy",
            title: "Hoy: " + dateToStr(today)
        });
        
        // Festivos colombianos 2024-2025 (ejemplo)
        var colombianHolidays = [
            new Date(2024, 0, 1),   // Año Nuevo
            new Date(2024, 0, 8),   // Reyes Magos
            new Date(2024, 2, 25),  // San José
            new Date(2024, 3, 28),  // Jueves Santo
            new Date(2024, 3, 29),  // Viernes Santo
            new Date(2024, 4, 1),   // Día del Trabajo
            new Date(2024, 4, 13),  // Ascensión
            new Date(2024, 5, 3),   // Corpus Christi
            new Date(2024, 5, 10),  // Sagrado Corazón
            new Date(2024, 6, 1),   // San Pedro y San Pablo
            new Date(2024, 6, 20),  // Independencia
            new Date(2024, 7, 7),   // Batalla de Boyacá
            new Date(2024, 7, 19),  // Asunción
            new Date(2024, 9, 14),  // Día de la Raza
            new Date(2024, 10, 4),  // Todos los Santos
            new Date(2024, 10, 11), // Independencia de Cartagena
            new Date(2024, 11, 8),  // Inmaculada Concepción
            new Date(2024, 11, 25), // Navidad
        ];
        
        // Colorear festivos
        gantt.templates.scale_cell_class = function(date) {
            var day = date.getDay();
            if (day == 0 || day == 6) {
                return "weekend";
            }
            for (var i = 0; i < colombianHolidays.length; i++) {
                var holiday = colombianHolidays[i];
                if (date.getFullYear() == holiday.getFullYear() &&
                    date.getMonth() == holiday.getMonth() &&
                    date.getDate() == holiday.getDate()) {
                    return "holiday";
                }
            }
            return "";
        };
        
        gantt.templates.timeline_cell_class = function(task, date) {
            var day = date.getDay();
            if (day == 0 || day == 6) {
                return "weekend";
            }
            for (var i = 0; i < colombianHolidays.length; i++) {
                var holiday = colombianHolidays[i];
                if (date.getFullYear() == holiday.getFullYear() &&
                    date.getMonth() == holiday.getMonth() &&
                    date.getDate() == holiday.getDate()) {
                    return "holiday";
                }
            }
            return "";
        };
        
        // Zoom levels
        var zoomConfig = {
            levels: [
                {
                    name: "day",
                    scale_height: 50,
                    min_column_width: 80,
                    scales: [
                        {unit: "day", step: 1, format: "%d %M"}
                    ]
                },
                {
                    name: "week",
                    scale_height: 50,
                    min_column_width: 50,
                    scales: [
                        {unit: "week", step: 1, format: function (date) {
                            var dateToStr = gantt.date.date_to_str("%d %M");
                            var endDate = gantt.date.add(date, -6, "day");
                            var weekNum = gantt.date.date_to_str("%W")(date);
                            return "#" + weekNum + ", " + dateToStr(date) + " - " + dateToStr(endDate);
                        }},
                        {unit: "day", step: 1, format: "%j %D"}
                    ]
                },
                {
                    name: "month",
                    scale_height: 50,
                    min_column_width: 120,
                    scales: [
                        {unit: "month", format: "%F, %Y"},
                        {unit: "week", format: "Semana #%W"}
                    ]
                }
            ]
        };
        
        gantt.ext.zoom.init(zoomConfig);
        gantt.ext.zoom.setLevel("week");
        
        // Inicializar Gantt
        gantt.init("gantt_here");
        
        // Cargar datos desde el servidor
        gantt.load("{% url 'proyectos:proyecto_gantt_dhtmlx_data' proyecto.id_proyecto %}");
        
        // Data processor para guardar cambios
        var dp = gantt.createDataProcessor({
            url: "{% url 'proyectos:proyecto_gantt_dhtmlx_save' proyecto.id_proyecto %}",
            mode: "REST"
        });
        
        // Manejar eventos de actualización
        gantt.attachEvent("onAfterTaskUpdate", function(id, task) {
            console.log("Tarea actualizada:", task);
        });
        
        gantt.attachEvent("onAfterLinkAdd", function(id, link) {
            console.log("Dependencia creada:", link);
        });
        
        gantt.attachEvent("onAfterLinkDelete", function(id, link) {
            console.log("Dependencia eliminada:", link);
        });
    </script>
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</body>
</html>
