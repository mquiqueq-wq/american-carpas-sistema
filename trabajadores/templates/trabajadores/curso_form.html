{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-4" style="max-width: 720px;">
  <h3 class="mb-3">{{ title }}</h3>

  <form method="post" novalidate>
    {% csrf_token %}
    <input type="hidden" id="tipos_meta" value='[{% for t in form.fields.tipo_curso.queryset %}{"id":{{ t.id_tipo_curso }},"vigencia":{{ t.vigencia_dias }} }{% if not forloop.last %},{% endif %}{% endfor %}]' />

    <div class="mb-3">
      <label class="form-label">{{ form.tipo_curso.label }}</label>
      {{ form.tipo_curso }}
      <div class="form-text">Selecciona un tipo para calcular vigencia.</div>
      {% for e in form.tipo_curso.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    </div>

    <div class="mb-3">
      <label class="form-label">{{ form.nombre_curso.label }}</label>
      {{ form.nombre_curso }}
      {% for e in form.nombre_curso.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    </div>

    <div class="mb-3">
      <label class="form-label">{{ form.institucion.label }}</label>
      {{ form.institucion }}
      {% for e in form.institucion.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    </div>

    <div class="row">
      <div class="col-md-6 mb-3">
        <label class="form-label">{{ form.fecha_inicio_curso.label }}</label>
        {{ form.fecha_inicio_curso }}
        {% for e in form.fecha_inicio_curso.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">{{ form.fecha_fin_curso.label }}</label>
        {{ form.fecha_fin_curso }}
        {% for e in form.fecha_fin_curso.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
      </div>
    </div>

    <div class="row">
      <div class="col-md-6 mb-3">
        <label class="form-label">{{ form.numero_certificado.label }}</label>
        {{ form.numero_certificado }}
        {% for e in form.numero_certificado.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">{{ form.certificado_url.label }}</label>
        {{ form.certificado_url }}
        {% for e in form.certificado_url.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">{{ form.es_renovacion_de.label }}</label>
      {{ form.es_renovacion_de }}
      {% for e in form.es_renovacion_de.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    </div>

    <div class="d-flex gap-2">
      <a href="{% url 'trabajadores:trabajador_detail' trabajador.id_trabajador %}" class="btn btn-outline-secondary">Cancelar</a>
      <button class="btn btn-primary" type="submit">Guardar</button>
    </div>
  </form>

  <div class="mt-3">
    <small id="info_vencimiento" class="text-muted"></small>
  </div>
</div>

<script>
(function() {
  const selectTipo = document.getElementById('id_tipo_curso');
  const fin = document.getElementById('id_fecha_fin_curso');
  const info = document.getElementById('info_vencimiento');
  let tipos = [];
  try {
    tipos = JSON.parse(document.getElementById('tipos_meta').value || '[]');
  } catch(e) { tipos = []; }

  function getVigencia(id) {
    const t = tipos.find(x => String(x.id) === String(id));
    return t ? parseInt(t.vigencia || 0, 10) : 0;
  }

  function formatISO(d) {
    const m = (d.getMonth()+1).toString().padStart(2,'0');
    const day = d.getDate().toString().padStart(2,'0');
    return `${d.getFullYear()}-${m}-${day}`;
  }

  function recompute() {
    const tipoId = selectTipo.value;
    const vig = getVigencia(tipoId);
    const finVal = fin.value;
    if (vig > 0 && finVal) {
      const d = new Date(finVal + 'T00:00:00');
      d.setDate(d.getDate() + vig);
      info.textContent = `Con la vigencia del tipo seleccionado (${vig} días), la fecha estimada de vencimiento sería: ${formatISO(d)}.`;
    } else {
      info.textContent = '';
    }
  }

  if (selectTipo) selectTipo.addEventListener('change', recompute);
  if (fin) fin.addEventListener('change', recompute);
  // inicial
  recompute();
})();
</script>
{% endblock %}