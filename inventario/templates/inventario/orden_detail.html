{% extends 'base.html' %}

{% block title %}Orden {{ orden.numero_orden }} - Inventario{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>
                <i class="bi bi-clipboard-check text-primary"></i> Orden de Producción: {{ orden.numero_orden }}
                {% if orden.es_urgente %}
                    <span class="badge bg-danger">URGENTE</span>
                {% endif %}
            </h2>
            <p class="text-muted mb-0">Detalle completo de la orden</p>
        </div>
        <div>
            <a href="{% url 'inventario:orden_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Volver
            </a>
            <a href="{% url 'inventario:orden_update' orden.pk %}" class="btn btn-primary">
                <i class="bi bi-pencil"></i> Editar
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Información de la Orden -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Información General</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong>Número de Orden:</strong>
                            <p class="mb-0">{{ orden.numero_orden }}</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Estado:</strong>
                            <p class="mb-0">
                                {% if orden.estado == 'PENDIENTE' %}
                                    <span class="badge bg-warning">Pendiente</span>
                                {% elif orden.estado == 'EN_PROCESO' %}
                                    <span class="badge bg-info">En Proceso</span>
                                {% elif orden.estado == 'COMPLETADA' %}
                                    <span class="badge bg-success">Completada</span>
                                {% elif orden.estado == 'CANCELADA' %}
                                    <span class="badge bg-secondary">Cancelada</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Fecha de Orden:</strong>
                            <p class="mb-0">{{ orden.fecha_orden|date:"d/m/Y" }}</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Fecha de Entrega:</strong>
                            <p class="mb-0">{{ orden.fecha_entrega_requerida|date:"d/m/Y"|default:"-" }}</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Cliente:</strong>
                            <p class="mb-0">{{ orden.cliente|default:"-" }}</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Proyecto:</strong>
                            <p class="mb-0">{{ orden.proyecto.nombre|default:"-" }}</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Ubicación de Entrega:</strong>
                            <p class="mb-0">{{ orden.ubicacion_entrega|default:"-" }}</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Solicitado por:</strong>
                            <p class="mb-0">{{ orden.solicitado_por.get_full_name|default:orden.solicitado_por.username }}</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Prioridad:</strong>
                            <p class="mb-0">
                                {% if orden.prioridad <= 2 %}
                                    <span class="badge bg-success">{{ orden.prioridad }} - Baja</span>
                                {% elif orden.prioridad == 3 %}
                                    <span class="badge bg-warning">{{ orden.prioridad }} - Media</span>
                                {% else %}
                                    <span class="badge bg-danger">{{ orden.prioridad }} - Alta</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Urgente:</strong>
                            <p class="mb-0">
                                {% if orden.es_urgente %}
                                    <span class="badge bg-danger">Sí</span>
                                {% else %}
                                    <span class="badge bg-secondary">No</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    
                    {% if orden.observaciones %}
                    <div class="mt-3">
                        <strong>Observaciones:</strong>
                        <p class="mb-0">{{ orden.observaciones }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Ítems de la Orden -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-box-seam"></i> Ítems / Productos</h5>
                    <a href="{% url 'inventario:orden_item_create' orden.pk %}" class="btn btn-sm btn-light">
                        <i class="bi bi-plus-circle"></i> Agregar Ítem
                    </a>
                </div>
                <div class="card-body">
                    {% if items %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Cant.</th>
                                        <th>Tipo</th>
                                        <th>Dimensiones</th>
                                        <th>Descripción</th>
                                        <th>Cortinas</th>
                                        <th>Logos</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in items %}
                                    <tr>
                                        <td><strong>{{ item.cantidad }}</strong></td>
                                        <td>{{ item.get_tipo_producto_display }}</td>
                                        <td>{{ item.dimensiones|default:"-" }}</td>
                                        <td>{{ item.descripcion_completa|truncatewords:10|default:"-" }}</td>
                                        <td>
                                            {% if item.incluye_cortinas %}
                                                <i class="bi bi-check-circle text-success"></i> {{ item.cantidad_cortinas }}
                                            {% else %}
                                                <i class="bi bi-x-circle text-muted"></i>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if item.incluye_logo_techo %}
                                                <i class="bi bi-check-circle text-success"></i> T:{{ item.cantidad_logos_techo }}
                                            {% endif %}
                                            {% if item.incluye_logo_cortina %}
                                                <i class="bi bi-check-circle text-success"></i> C:{{ item.cantidad_logos_cortina }}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">No hay ítems registrados</p>
                    {% endif %}
                </div>
            </div>

            <!-- Consumo de Materiales -->
            <div class="row">
                <div class="col-md-4">
                    <div class="card mb-4">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="bi bi-layers"></i> Lonas</h6>
                        </div>
                        <div class="card-body">
                            {% if consumo_lonas %}
                                <ul class="list-unstyled mb-0">
                                    {% for consumo in consumo_lonas %}
                                    <li class="mb-2">
                                        <small>
                                            {{ consumo.lona.codigo }}<br>
                                            <strong>{{ consumo.metros_consumidos }} m</strong>
                                        </small>
                                    </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="text-muted mb-0"><small>Sin consumo</small></p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card mb-4">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0"><i class="bi bi-building"></i> Estructura</h6>
                        </div>
                        <div class="card-body">
                            {% if consumo_estructura %}
                                <ul class="list-unstyled mb-0">
                                    {% for consumo in consumo_estructura %}
                                    <li class="mb-2">
                                        <small>
                                            {{ consumo.estructura.codigo }}<br>
                                            <strong>
                                                {% if consumo.metros_consumidos %}
                                                    {{ consumo.metros_consumidos }} m
                                                {% else %}
                                                    {{ consumo.piezas_consumidas }} pzs
                                                {% endif %}
                                            </strong>
                                        </small>
                                    </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="text-muted mb-0"><small>Sin consumo</small></p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card mb-4">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0"><i class="bi bi-tools"></i> Accesorios</h6>
                        </div>
                        <div class="card-body">
                            {% if consumo_accesorios %}
                                <ul class="list-unstyled mb-0">
                                    {% for consumo in consumo_accesorios %}
                                    <li class="mb-2">
                                        <small>
                                            {{ consumo.accesorio.nombre }}<br>
                                            <strong>{{ consumo.cantidad_consumida }}</strong>
                                        </small>
                                    </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="text-muted mb-0"><small>Sin consumo</small></p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel Lateral -->
        <div class="col-lg-4">
            <!-- Progreso -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-bar-chart"></i> Progreso</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <small class="text-muted">Porcentaje completado</small>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar" role="progressbar" style="width: {{ orden.porcentaje_completado }}%;">
                                {{ orden.porcentaje_completado }}%
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <small><i class="bi bi-calendar-check text-success"></i> Iniciada: {{ orden.fecha_inicio|date:"d/m/Y"|default:"-" }}</small>
                    </div>
                    <div>
                        <small><i class="bi bi-calendar-x text-danger"></i> Completada: {{ orden.fecha_completado|date:"d/m/Y"|default:"-" }}</small>
                    </div>
                </div>
            </div>

            <!-- Auditoría -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-clock-history"></i> Auditoría</h6>
                </div>
                <div class="card-body">
                    <small class="text-muted">Creado por:</small>
                    <p class="mb-2">{{ orden.creado_por.get_full_name|default:orden.creado_por.username }}</p>
                    
                    <small class="text-muted">Fecha de creación:</small>
                    <p class="mb-2">{{ orden.fecha_creacion|date:"d/m/Y H:i" }}</p>
                    
                    <small class="text-muted">Última actualización:</small>
                    <p class="mb-0">{{ orden.fecha_actualizacion|date:"d/m/Y H:i" }}</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
